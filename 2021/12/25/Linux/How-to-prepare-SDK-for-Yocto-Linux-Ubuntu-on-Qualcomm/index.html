<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Arial:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"huaqianlee.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":"ture","color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="What does SDK mean in current context?很多时候，我们需要闭源一部分源码， 然后再把整个源码仓库共享给指定人员。这个源码仓库就称之为 SDK。 How to make SDK based on Yocto build system根据目前的调查结论，基于 Yocto 编译系统做 SDK 主要有如下三种方式，本文主要介绍第一种方式，也会稍微介绍下第二、三种方式。">
<meta property="og:type" content="article">
<meta property="og:title" content="How to prepare SDK for Yocto Linux&#x2F;Ubuntu on Qualcomm">
<meta property="og:url" content="http://huaqianlee.github.io/2021/12/25/Linux/How-to-prepare-SDK-for-Yocto-Linux-Ubuntu-on-Qualcomm/index.html">
<meta property="og:site_name" content="Andy.Lee&#39;s  Blog">
<meta property="og:description" content="What does SDK mean in current context?很多时候，我们需要闭源一部分源码， 然后再把整个源码仓库共享给指定人员。这个源码仓库就称之为 SDK。 How to make SDK based on Yocto build system根据目前的调查结论，基于 Yocto 编译系统做 SDK 主要有如下三种方式，本文主要介绍第一种方式，也会稍微介绍下第二、三种方式。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-12-25T14:30:32.000Z">
<meta property="article:modified_time" content="2022-12-25T06:33:04.586Z">
<meta property="article:author" content="Andy.Lee">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://huaqianlee.github.io/2021/12/25/Linux/How-to-prepare-SDK-for-Yocto-Linux-Ubuntu-on-Qualcomm/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>How to prepare SDK for Yocto Linux/Ubuntu on Qualcomm | Andy.Lee's  Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Andy.Lee's  Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Good good study, day day up !</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">123</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">34</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">33</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://huaqianlee.github.io/2021/12/25/Linux/How-to-prepare-SDK-for-Yocto-Linux-Ubuntu-on-Qualcomm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy.Lee">
      <meta itemprop="description" content="Just need to enjoy life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Andy.Lee's  Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          How to prepare SDK for Yocto Linux/Ubuntu on Qualcomm
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Dec 25 2021 22:30:32" itemprop="dateCreated datePublished" datetime="2021-12-25T22:30:32+08:00">Dec 25 2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Dec 25 2022 14:33:04" itemprop="dateModified" datetime="2022-12-25T14:33:04+08:00">Dec 25 2022</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Tree/" itemprop="url" rel="index"><span itemprop="name">Linux Tree</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Tree/Ycoto/" itemprop="url" rel="index"><span itemprop="name">Ycoto</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="What-does-SDK-mean-in-current-context"><a href="#What-does-SDK-mean-in-current-context" class="headerlink" title="What does SDK mean in current context?"></a>What does SDK mean in current context?</h1><p>很多时候，我们需要闭源一部分源码， 然后再把整个源码仓库共享给指定人员。这个源码仓库就称之为 SDK。</p>
<h1 id="How-to-make-SDK-based-on-Yocto-build-system"><a href="#How-to-make-SDK-based-on-Yocto-build-system" class="headerlink" title="How to make SDK based on Yocto build system"></a>How to make SDK based on Yocto build system</h1><p>根据目前的调查结论，基于 Yocto 编译系统做 SDK 主要有如下三种方式，本文主要介绍第一种方式，也会稍微介绍下第二、三种方式。</p>
<ul>
<li>将闭源部分源码做成 prebuilt 包;</li>
<li>重写 <code>do_install</code> 任务直接安装闭源部分源码生成的 deb 包;</li>
<li>将源码编译成二进制并替换，修改 Makefile 文件。</li>
</ul>
<p>最开始倾向于以 2、3 的方式来做 SDK， 深入调查后发现 1 才是最合适的方式，原因有三：</p>
<ul>
<li>高通有开发一个基于 <code>qprebuilt.bbclass</code> 类来实现的半成品 prebuilt 功能， 而且高通的闭源源码也是按照这种方式处理的。</li>
<li>直接安装预编译的 deb 包是一个糟糕的决定，会给以后带来很多不确定性和不可追溯性。</li>
<li>编译二进制并替换的方式在 Yocto 中逻辑更为复杂，且不符合官方推荐的标准做法。</li>
</ul>
<h2 id="Create-Prebuilt-tarball"><a href="#Create-Prebuilt-tarball" class="headerlink" title="Create Prebuilt tarball"></a>Create Prebuilt tarball</h2><p>制作预编译包是官方比较推荐的一种方式，详细过程请查看 “Lessons and Gains of making prebuilt sdk” 部分。现以 RB5 LU 为例将准备步骤简单总结如下，其分为两种情况：</p>
<ul>
<li>可以生成中间产物，用中间产物创建；</li>
<li>不能生成中间产物，直接取最终产物创建。</li>
</ul>
<blockquote>
<p>我们也可以跳过第一种情况，直接按照第二种方式准备所有模块的预编译包，可以直接跳过如下第 2 步。</p>
</blockquote>
<ol>
<li>找到并修改闭源代码对应的 bb 文件, 添加如下两行代码。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RB5 LU 需要修改如下文件：</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bsp-prop/recipes-bsp/sensors/sensors-see_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bt/recipes/bt-app/bt-app_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bt/recipes/bt-cert/bt-cert_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bt/recipes/bthost-ipc/bthost-ipc_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bt/recipes/fluoride/fluoride_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-bt/recipes/libbt-vendor/libbt-vendor_git.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-camera-prop/recipes/camx/camx_0.1.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-camera-prop/recipes/camx/camxlib_0.1.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-camera-prop/recipes/camx/chicdk_0.1.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-gst-prop/recipes/secure-gst/secure-gst.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-robotics-prop/recipes/imud/imud.bb</span></span><br><span class="line"><span class="comment"># poky/meta-qti-sensors-prop/recipes/sensors/sensors-see-qti_git.bb</span></span><br><span class="line"></span><br><span class="line">RM_WORK_EXCLUDE += <span class="string">&quot;<span class="variable">$&#123;PN&#125;</span>&quot;</span> <span class="comment"># 也可以添加所有模块到 local.conf， 譬如： RM_WORK_EXCLUDE += &quot;camx chicdk ...&quot;</span></span><br><span class="line">inherit qprebuilt <span class="comment"># 如果 bb 文件已经继承了此类，就不需要增加此行</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ol start="2">
<li>进入对应模块 “non-stripped” 或者 “stripped” 路径，执行如下脚本生成预编译包。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create_prebuilt_targz.sh</span></span><br><span class="line"><span class="comment"># create tarball</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that PWD should be in subdir prebuilt/non-stripped/ of recipe WORKDIR</span></span><br><span class="line"><span class="comment"># e.g: apps_proc/build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/work/aarch64-oe-linux/libgpt/1.0-r0/prebuilt/stripped/</span></span><br><span class="line"><span class="keyword">function</span> check_pwd()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># If we want to put this script into &quot;stripped&quot;, we need to modify the following ‘if’ condition.</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(basename $PWD)</span>&quot;</span> != <span class="string">&quot;non-stripped&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;please change into subdir prebuilt/stripped/ of recipe WORKDIR&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> get_targz_name()</span><br><span class="line">&#123;</span><br><span class="line">    WORKDIR=<span class="variable">$&#123;PWD/prebuilt*/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> WORKDIR=<span class="variable">$WORKDIR</span></span><br><span class="line"></span><br><span class="line">    PV_BASE=$(basename <span class="variable">$WORKDIR</span>)</span><br><span class="line">    PV=<span class="variable">$&#123;PV_BASE/-*/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> PV=<span class="variable">$PV</span></span><br><span class="line">    PN_DIR=$(dirname <span class="variable">$WORKDIR</span>)</span><br><span class="line">    PN=$(basename <span class="variable">$PN_DIR</span>)</span><br><span class="line">    <span class="built_in">echo</span> PN=<span class="variable">$&#123;PN&#125;</span></span><br><span class="line">    PACKAGE_ARCH_DIR=$(dirname <span class="variable">$&#123;PN_DIR&#125;</span>)</span><br><span class="line">    PACKAGE_ARCH_BASE=$(basename <span class="variable">$&#123;PACKAGE_ARCH_DIR&#125;</span>)</span><br><span class="line">    PACKAGE_ARCH=<span class="variable">$&#123;PACKAGE_ARCH_BASE/-oe-linux/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> PACKAGE_ARCH=<span class="variable">$PACKAGE_ARCH</span></span><br><span class="line">    PREBUILT_TARGZ_NAME=<span class="variable">$&#123;PN&#125;</span>_<span class="variable">$&#123;PV&#125;</span>_<span class="variable">$&#123;PACKAGE_ARCH&#125;</span>.tar.gz</span><br><span class="line">    <span class="built_in">echo</span> PREBUILT_TARGZ_NAME=<span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_pwd</span><br><span class="line"><span class="built_in">echo</span> OK</span><br><span class="line">get_targz_name</span><br><span class="line">tar cvfz <span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span> *</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>部分模块没有中间产物，可以按照如下方式准备预编译包。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Get files based on one of the two following ways</span></span><br><span class="line">ar vx sensors-see-qti_0-r0_arm64.deb</span><br><span class="line">tar -xvf data.tar.xz -C data/</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">cp build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/sysroots-components/aarch64/sensors-see-qti/* data/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Get licenses</span></span><br><span class="line">cp build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/deploy/licenses/sensors-see-qti data/__LIC__</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Make tarball</span></span><br><span class="line">tar -cjvf sensors-see-qti_git_aarch64.tar.gz data/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝预编译包到预编译路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RB5 prebuilt path</span></span><br><span class="line">cp *.tar.gz apps_proc/prebuilt_HY11</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除源码，清理<code>git</code>记录。</p>
</li>
<li><p>编译确认，可能会遇到编译错误，我们需要按照步骤 1~3 准备对应的预编译包。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如下是 RB5 的修改参考。</span></span><br><span class="line"><span class="comment"># Modified script</span></span><br><span class="line">create_prebuilt_targz.sh</span><br><span class="line">poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span><br><span class="line">poky/meta-qti-bsp-prop/recipes-bsp/sensors/sensors-see_git.bb</span><br><span class="line">poky/meta-qti-bt/recipes/bt-app/bt-app_git.bb</span><br><span class="line">poky/meta-qti-bt/recipes/bt-cert/bt-cert_git.bb</span><br><span class="line">poky/meta-qti-bt/recipes/bthost-ipc/bthost-ipc_git.bb</span><br><span class="line">poky/meta-qti-bt/recipes/fluoride/fluoride_git.bb</span><br><span class="line">poky/meta-qti-bt/recipes/libbt-vendor/libbt-vendor_git.bb</span><br><span class="line">poky/meta-qti-camera-prop/recipes/camx/camx_0.1.bb</span><br><span class="line">poky/meta-qti-camera-prop/recipes/camx/camxlib_0.1.bb</span><br><span class="line">poky/meta-qti-camera-prop/recipes/camx/chicdk_0.1.bb</span><br><span class="line">poky/meta-qti-gst-prop/recipes/secure-gst/secure-gst.bb</span><br><span class="line">poky/meta-qti-robotics-prop/recipes/imud/imud.bb</span><br><span class="line">poky/meta-qti-sensors-prop/recipes/sensors/sensors-see-qti_git.bb</span><br><span class="line"></span><br><span class="line"><span class="comment"># prebuilt package</span></span><br><span class="line">prebuilt_HY11/bt-app_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/bt-cert_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/bttransport_1.0_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/camx_0.1_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/chicdk_0.1_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/fluoride_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/gstreamer1.0-plugins-qtivdec_1.0_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/hci-qcomm-init_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/imu-ros2node_0.1_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/imud_1.0_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/libbt-vendor_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/sensors-see-qti_0-r0_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/sensors-see-qti_git_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/sns-imud-ros_1.0_aarch64.tar.gz</span><br><span class="line">prebuilt_HY11/vslam_1.0_aarch64.tar.gz</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="Install-deb-directly"><a href="#Install-deb-directly" class="headerlink" title="Install deb directly"></a>Install deb directly</h2><p>安装预编译的 deb 包这种方式的主要步骤是：</p>
<ol>
<li>找到所有闭源部分编译生成的 deb 包。</li>
<li>删除闭源部分源码和 git 历史记录。</li>
<li>编写一个 bb 文件去安装所有预编译的 deb 包。</li>
</ol>
<p><code>bb</code> 文件的写法可以参考如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install-deb.bb</span></span><br><span class="line">SUMMARY = <span class="string">&quot;Recipe for installing deb package&quot;</span></span><br><span class="line">DESCRIPTION = <span class="string">&quot;It installs own deb package&quot;</span></span><br><span class="line">HOMEPAGE = <span class="string">&quot;&quot;</span></span><br><span class="line">LICENSE = <span class="string">&quot;CLOSED&quot;</span></span><br><span class="line"></span><br><span class="line">DEPENDS += <span class="string">&quot;dpkg-native&quot;</span></span><br><span class="line"></span><br><span class="line">inherit bin_package</span><br><span class="line"></span><br><span class="line">SRC_URI += <span class="string">&quot; \</span></span><br><span class="line"><span class="string">    file://own_xxx_aarch.deb;unpack=0 \</span></span><br><span class="line"><span class="string">&quot;</span> <span class="comment"># &#x27;;unpack=0&#x27; to turn off the unpacking motion</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_install_append</span></span>() &#123;</span><br><span class="line">    touch <span class="variable">$&#123;STAGING_DIR_NATIVE&#125;</span>/var/lib/dpkg/status</span><br><span class="line">    <span class="variable">$&#123;STAGING_BINDIR_NATIVE&#125;</span>/dpkg  --instdir=<span class="variable">$&#123;D&#125;</span>/ \</span><br><span class="line">    --admindir=<span class="variable">$&#123;STAGING_DIR_NATIVE&#125;</span>/var/lib/dpkg/ \</span><br><span class="line">    --force-architecture arm -i <span class="variable">$&#123;WORKDIR&#125;</span>/own_xxx_aarch.deb  <span class="comment"># &#x27;--force-architecture&#x27; to specify architecture</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FILES_<span class="variable">$&#123;PN&#125;</span> += <span class="string">&quot; \</span></span><br><span class="line"><span class="string">    /usr/bin/ \</span></span><br><span class="line"><span class="string">    /etc/     \</span></span><br><span class="line"><span class="string">    /...      \</span></span><br><span class="line"><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>小提示： 可以根据编译的错误日志找到完整的文件列表。</p>
</blockquote>
<h2 id="Compile-and-replace-with-binary"><a href="#Compile-and-replace-with-binary" class="headerlink" title="Compile and replace with binary"></a>Compile and replace with binary</h2><p>编译二进制并替换的方式的主要步骤如下：</p>
<ol>
<li>编译源码，拷贝闭源部分生成的二进制文件替换对应源码。</li>
<li>修改步骤 1 对应类 Makefile 文件，以便直接打包二进制而不用再去编译源码。</li>
<li>编译通过，并与原始编译结果对比，确保没有文件缺失。</li>
</ol>
<p>此方式没有深入研究，所以就这样稍微介绍下了。</p>
<h1 id="Lessons-and-Gains-of-making-prebuilt-sdk"><a href="#Lessons-and-Gains-of-making-prebuilt-sdk" class="headerlink" title="Lessons and Gains of making prebuilt sdk"></a>Lessons and Gains of making prebuilt sdk</h1><p>要准备<code>prebuilt sdk</code>， 第一步需要搞明白的就是 <code>qprebuilt.bbclass</code> 文件，代码一开始就有如下简要注释说明这个类文件的作用。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路径：apps_proc/poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For recipe inheriting &#x27;qprebuilt&#x27;, this class allows to:</span></span><br><span class="line"><span class="comment">#    - Generate prebuilt package(s) from &#x27;installed&#x27; files</span></span><br><span class="line"><span class="comment">#      (content of $&#123;D&#125;) and place them in DEPLOY_DIR_PREBUILT.</span></span><br><span class="line"><span class="comment">#    - Use prebuilt package instead of fetching and compiling</span></span><br><span class="line"><span class="comment">#      the source, when PREBUILT_SRC_DIR is defined.</span></span><br></pre></td></tr></table></figure>

<p>简单总结起来，这个基类主要做如下三件事， 其他模块（bb 文件）可以继承此基类从实现 <code>prebuilt</code> 的功能，详情可以查看源码注释。</p>
<ol>
<li>如果 <code>prebuilt</code> 包不存在，则创建 <code>prebuilt</code> 包。</li>
<li>编译依赖文件。</li>
<li>如果 <code>prebuilt</code> 包已存在，则使用 <code>prebuilt</code> 包并跳过编译。</li>
</ol>
<p>但是实测发现，上述 1 并未成功执行， 2 和 3 可以成功执行。</p>
<blockquote>
<p>2021/12/15: 当前时间节点的 SOM 基线此功能还是一个半成品，不适用与所有模块，需要做一些修改，详见下文。</p>
</blockquote>
<h2 id="Locating-problem-with-enhanced-log"><a href="#Locating-problem-with-enhanced-log" class="headerlink" title="Locating problem with enhanced log"></a>Locating problem with enhanced log</h2><p>按照如下方式在 <code>qprebuilt.bbclass</code> 文件中添加或修改日志定位问题点。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bb.plain(msg): Writes msg as is to the <span class="built_in">log</span> <span class="keyword">while</span> also logging to stdout.</span><br><span class="line">bb.note(msg): Writes <span class="string">&quot;NOTE: msg&quot;</span> to the <span class="built_in">log</span>. Also logs to stdout <span class="keyword">if</span> BitBake is called with <span class="string">&quot;-v&quot;</span>.</span><br><span class="line">bb.debug(level, msg): Writes <span class="string">&quot;DEBUG: msg&quot;</span> to the <span class="built_in">log</span>. Also logs to stdout <span class="keyword">if</span> the <span class="built_in">log</span> level is greater than or equal to level. See the <span class="string">&quot;-D&quot;</span> option <span class="keyword">in</span> the BitBake User Manual <span class="keyword">for</span> more information.</span><br><span class="line">bb.warn(msg): Writes <span class="string">&quot;WARNING: msg&quot;</span> to the <span class="built_in">log</span> <span class="keyword">while</span> also logging to stdout.</span><br><span class="line">bb.error(msg): Writes <span class="string">&quot;ERROR: msg&quot;</span> to the <span class="built_in">log</span> <span class="keyword">while</span> also logging to stdout.</span><br><span class="line">bb.fatal(msg): This logging <span class="keyword">function</span> is similar to bb.error(msg) but also causes the calling task to fail.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注： <code>bb，bbclass</code> 文件大部分内容是用 python 编写，可以直接用如上方式打印日志，如果是 <strong>BASH</strong> 脚本的话请使用：<code>bbnote &quot;msg&quot;,bbdebug level &quot;msg&quot;, bbwarn &quot;msg&quot;, bberror &quot;msg&quot;, bbfatal &quot;msg&quot;</code>。</p>
</blockquote>
<p>另外，我们也可以在编译的时候指定 <code>Debug</code> 等级打开默认的日志，譬如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -DD sets the debug level to 2 to open all debug logs.</span></span><br><span class="line">bitbake -<span class="built_in">fc</span> -DD compile <span class="variable">$1</span> <span class="comment"># `$1` 指编译的 bb</span></span><br></pre></td></tr></table></figure>

<h2 id="No-files-to-create-tarball"><a href="#No-files-to-create-tarball" class="headerlink" title="No files to create tarball"></a>No files to create tarball</h2><p>打开增强日志后，发现关键信息 “No files to create tarball”， 似乎当尝试去创建预编译包时，找不到对应的中间产物。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">build_hlos.log:19539:NOTE: Running task 5461 of 5555 (/home/user/host/code_space/poseidonhw/PoseidonHW-rb5165-lu1.0-dev/apps_proc/poky/meta-qti-camera-prop/recipes/camx/chicdk_0.1.bb:do_generate_prebuilt)</span><br><span class="line">build_hlos.log:19584:NOTE: recipe chicdk-0.1-r0: task do_generate_prebuilt: Started</span><br><span class="line">build_hlos.log:19586:WARNING: chicdk-0.1-r0 do_generate_prebuilt: **No files to create archive** /home/user/host/code_space/poseidonhw/PoseidonHW-rb5165-lu1.0-dev/apps_proc/build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/work/aarch64-oe-linux/chicdk/0.1-r0/prebuiltdata/HY11_chicdk_0.1_aarch64.tar</span><br></pre></td></tr></table></figure>

<h2 id="do-generate-prebuilt"><a href="#do-generate-prebuilt" class="headerlink" title="do_generate_prebuilt"></a>do_generate_prebuilt</h2><p>如上日志由 <code>qprebuilt.bbclass</code> 中的 <code>do_generate_prebuilt</code> 打印， 关键源码如下。 </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apps_proc/poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span></span><br><span class="line"><span class="comment"># Please find what does these sentences mean in the following quote information, which named bitbatke user manual.</span></span><br><span class="line">SSTATETASKS += <span class="string">&quot;do_generate_prebuilt&quot;</span></span><br><span class="line">do_generate_prebuilt[dirs] = <span class="string">&quot;$&#123;D&#125;&quot;</span></span><br><span class="line">do_generate_prebuilt[cleandirs] = <span class="string">&quot;$&#123;PREBUILT_DIR&#125; $&#123;PREBUILT_DATA_DIR&#125;&quot;</span></span><br><span class="line">do_generate_prebuilt[sstate-inputdirs] = <span class="string">&quot;$&#123;PREBUILT_DATA_DIR&#125;&quot;</span></span><br><span class="line">do_generate_prebuilt[sstate-outputdirs] = <span class="string">&quot;$&#123;DEPLOY_DIR_PREBUILT&#125;&quot;</span></span><br><span class="line">do_generate_prebuilt[stamp-extra-info] = <span class="string">&quot;$&#123;MACHINE_ARCH&#125;&quot;</span></span><br><span class="line">do_generate_prebuilt[doc] = <span class="string">&quot;Create a prebuilt package&quot;</span></span><br><span class="line">do_generate_prebuilt[vardeps] = <span class="string">&quot;$&#123;@gen_prebuiltvar(d)&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">python do_generate_prebuilt() &#123;</span><br><span class="line">    <span class="keyword">import</span> shutil</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ppackage <span class="keyword">in</span> ppackages:</span><br><span class="line">        <span class="keyword">for</span> variant <span class="keyword">in</span> pbvariants:</span><br><span class="line">            files = d.getVar(variant + <span class="string">&quot;_PREBUILT_FILES_&quot;</span> + ppackage)</span><br><span class="line">            bb.warn(<span class="string">&quot;No files to create archive %s-%s-%s&quot;</span> %(files, variant, ppackage))</span><br><span class="line">            stripped = d.getVar(<span class="string">&quot;PREBUILT_STRIP_&quot;</span> + ppackage)</span><br><span class="line">            tarball = <span class="string">&quot;%s/%s_%s_%s_%s.tar&quot;</span> % (prebuiltdatadir, variant, ppackage, pv, arch)</span><br><span class="line">            base = prebuiltdir</span><br><span class="line"></span><br><span class="line">            <span class="comment"># If no file specified quitely quit</span></span><br><span class="line">            <span class="keyword">if</span> files:</span><br><span class="line">                files = files.split() <span class="comment"># Split files to create tarball</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                bb.debug(<span class="number">1</span>, <span class="string">&quot;No files to create archive %s&quot;</span> %(tarball))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">python () &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> found:</span><br><span class="line">        <span class="comment"># Use prebuilt, discard build operations</span></span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> d.getVar(<span class="string">&#x27;PREBUILT_DISCARDED_TASKS&#x27;</span>).split():</span><br><span class="line">            ...</span><br><span class="line">        bb.build.addtask(<span class="string">&#x27;do_install_prebuilt&#x27;</span>, <span class="string">&#x27;do_populate_sysroot&#x27;</span>, <span class="string">&#x27;do_install&#x27;</span>, d) <span class="comment"># do_install_prebuilt to replace building with installing prebuilt package</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">elif</span> d.getVar(<span class="string">&#x27;DEPLOY_DIR_PREBUILT&#x27;</span>):</span><br><span class="line">        <span class="comment"># Create prebuilt tarball(s)</span></span><br><span class="line">        bb.build.addtask(<span class="string">&#x27;do_generate_prebuilt&#x27;</span>, <span class="string">&#x27;do_package&#x27;</span>, <span class="string">&#x27;do_install&#x27;</span>, d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>d.getVar()</code> comes from <code>apps_proc/poky/bitbake/lib/bb/tests/data.py</code>.<br><a target="_blank" rel="noopener" href="https://www.yoctoproject.org/docs/2.2.4/bitbake-user-manual/bitbake-user-manual.html">bitbatke user manual</a><br>[dirs]: Directories that should be created before the task runs. Directories that already exist are left as is. The last directory listed is used as the current working directory for the task.<br>[vardeps]: Specifies a space-separated list of additional variables to add to a variable’s dependencies for the purposes of calculating its signature. Adding variables to this list is useful, for example, when a function refers to a variable in a manner that does not allow BitBake to automatically determine that the variable is referred to.<br>[umask]: The umask to run the task under.</p>
</blockquote>
<p>首先 <code>qprebuilt.bbclass</code> 会去 <code>$workspace/prebuilt_HY11</code> 路径查找是否存在预编译包。如若存在，则直接加载并跳过编译；如若不存在，则编译并调用 <code>do_generate_prebuilt</code> 创建预编译包。而当前情况是尝试创建预编译包时发现文件为空。到这一步，逻辑就比较清楚了，接下来需要去搞清楚中间产物是什么，然后为什么 Python 脚本找不到这些文件。</p>
<h2 id="What-file-is-used-to-create-tarball"><a href="#What-file-is-used-to-create-tarball" class="headerlink" title="What file is used to create tarball"></a>What file is used to create tarball</h2><p>从 <code>qprebuilt.bbclass</code> 文件的如下注释和源码可以知道中间产物是 <code>all &#39;installed&#39; files (content of $&#123;D&#125;)</code>， 即通过打包所有 ‘installled (${D})’ 的文件生成 Prebuilt 包。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apps_proc/poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ### Creating prebuilt package(s)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default, a prebuilt package is generated with all &#x27;installed&#x27;</span></span><br><span class="line"><span class="comment"># files (content of $&#123;D&#125;).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It&#x27;s possible to strip binaries before packaging by setting</span></span><br><span class="line"><span class="comment"># PREBUILT_STRIP_$&#123;PN&#125; variable to &quot;1&quot;, default is &quot;0&quot;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It&#x27;s possible to create several prebuilt packages with different</span></span><br><span class="line"><span class="comment"># content, using PREBUILT_PACKAGES and PREBUILT_FILES_package-name</span></span><br><span class="line"><span class="comment"># variables.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># E.g. libvendor-1.8.bb - PN=&quot;libvendor&quot; ARCH=&quot;aarch64&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># PREBUILT_PACKAGES = &quot;$&#123;PN&#125;-full $&#123;PN&#125;-stripped $&#123;PN&#125;-minimal&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_FILES_$&#123;PN&#125;-full = &quot;/&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_FILES_$&#123;PN&#125;-stripped = &quot;/&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_STRIP_$&#123;PN&#125;-stripped = &quot;1&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_FILES_$&#123;PN&#125;-minimal = &quot;$&#123;bindir&#125; $&#123;libdir&#125;&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_STRIP_$&#123;PN&#125;-minimal = &quot;1&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This will create three archives:</span></span><br><span class="line"><span class="comment">#   libvendor-full_1.8_aarch64.tar.gz</span></span><br><span class="line"><span class="comment">#   libvendor-stripped_1.8_aarch64.tar.gz (stripped content)</span></span><br><span class="line"><span class="comment">#   libvendor-minimal_1.8_aarch64.tar.gz  (stripped content)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These prebuilt packages can then be distribuded to customers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note - by default:</span></span><br><span class="line"><span class="comment"># PREBUILT_PACKAGES = &quot;$&#123;PN&#125;&quot;</span></span><br><span class="line"><span class="comment"># PREBUILT_FILES_$&#123;PN&#125; = &quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">python do_generate_prebuilt() &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    prebuiltdir = os.path.join(d.getVar(<span class="string">&#x27;PREBUILT_DIR&#x27;</span>), <span class="string">&quot;non-stripped&quot;</span>)</span><br><span class="line">    prebuiltstrippeddir = os.path.join(d.getVar(<span class="string">&#x27;PREBUILT_DIR&#x27;</span>), <span class="string">&quot;stripped&quot;</span>)</span><br><span class="line">    prebuiltdatadir = d.getVar(<span class="string">&#x27;PREBUILT_DATA_DIR&#x27;</span>)</span><br><span class="line">    inputdir = d.getVar(<span class="string">&#x27;D&#x27;</span>) <span class="comment"># Get $&#123;D&#125;</span></span><br><span class="line">    licensedir = os.path.join(d.getVar(<span class="string">&#x27;LICENSE_DIRECTORY&#x27;</span>), pn)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Copy $&#123;D&#125;</span></span><br><span class="line">    shutil.copytree(inputdir, prebuiltdir, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add license</span></span><br><span class="line">    shutil.copytree(licensedir, prebuiltdir + <span class="string">&quot;/__LIC__&quot;</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fork and strip</span></span><br><span class="line">    shutil.copytree(prebuiltdir, prebuiltstrippeddir, <span class="literal">True</span>)</span><br><span class="line">    strip_dir(d, prebuiltstrippeddir)</span><br><span class="line">    ...</span><br><span class="line">    stripped = d.getVar(<span class="string">&quot;PREBUILT_STRIP_&quot;</span> + ppackage)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compress files in &quot;non-stripped&quot; in default</span></span><br><span class="line">    base = prebuiltdir</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># If this package is stripped, compress files in &quot;stripped&quot; </span></span><br><span class="line">    <span class="keyword">if</span> stripped <span class="keyword">and</span> stripped != <span class="string">&quot;0&quot;</span>:</span><br><span class="line">        base = prebuiltstrippeddir</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fakeroot python do_install_prebuilt() &#123; <span class="comment"># fakeroot gives the root permission to current process</span></span><br><span class="line">    <span class="comment"># Install license</span></span><br><span class="line">    cmd = <span class="string">&quot;cp -r %s/__LIC__ %s/%s&quot;</span> % (dest, licensedir, pn)</span><br><span class="line">    (retval, output) = oe.utils.getstatusoutput(cmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从如上源码可以看到，中间产物（包括 License 文件）都被拷贝到了 “non-stripped” 路径， 并 strip(移除调试符号表等信息) 然后拷贝到 “stripped” 路径中。如果当前 package 是 stripped 的，就打包 “stripped” 路径下的文件，否则默认打包 “non-stripped” 路径下的文件。</p>
<p>添加日志进行确认，打印<code>prebuilt</code>相关的文件和路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># code</span></span><br><span class="line">python <span class="function"><span class="title">do_generate_prebuilt</span></span>() &#123;</span><br><span class="line">    ...</span><br><span class="line">    bb.warn(<span class="string">&quot;added by lee to confirm D %s-%s: %s-%s&quot;</span> % (inputdir, prebuiltdir, licensedir, prebuiltstrippeddir))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># log output</span></span><br><span class="line">WARNING: camx-0.1-r0 do_generate_prebuilt: added by lee to confirm D <span class="string">&#x27;/home/.../apps_proc/chicdk/tmp-glibc/work/aarch64-oe-linux/camx/0.1-r0/image&#x27;</span>-<span class="string">&#x27;/home/.../apps_proc/chicdk/tmp-glibc/work/aarch64-oe-linux/camx/0.1-r0/prebuilt/non-stripped&#x27;</span>: <span class="string">&#x27;/home/.../apps_proc/chicdk/tmp-glibc/deploy/licenses/camx&#x27;</span>-<span class="string">&#x27;/home/.../apps_proc/chicdk/tmp-glibc/work/aarch64-oe-linux/camx/0.1-r0/prebuilt/stripped&#x27;</span></span><br></pre></td></tr></table></figure>

<p>至此，基本搞明白中间产物是什么东西了，但当我尝试去编译产物中找对应的文件或路径时，发现怎么都找不到。</p>
<h2 id="What-is-‘D’"><a href="#What-is-‘D’" class="headerlink" title="What is ‘D’"></a>What is ‘D’</h2><p>广告插播， ‘D’ 变量在打包的时多次出现，可是看到它的时候一脸懵逼，所以按照如下方式做了一下基本的确认。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Searching in code</span></span><br><span class="line">$ grep -rHn <span class="string">&quot;&#x27;D&#x27;&quot;</span> apps_proc/poky</span><br><span class="line">os.environ[<span class="string">&#x27;D&#x27;</span>] = self.target_rootfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Searching in Yocto explanation</span></span><br><span class="line">Meanwhile, DESTDIR is a path within the Build Directory. However, when the recipe builds a native program (i.e. one that is intended to run on the build machine), that program is never installed directly to the build machine<span class="string">&#x27;s root file system.</span></span><br></pre></td></tr></table></figure>

<h2 id="Why-the-file-required-by-tarball-does-not-exist"><a href="#Why-the-file-required-by-tarball-does-not-exist" class="headerlink" title="Why the file required by tarball does not exist"></a>Why the file required by tarball does not exist</h2><p>针对找不到中间产物这个问题，我的猜想是被编译系统清理了， 所以我从三个方向去寻找其缘由，然后三个方向的结果皆印证了我的猜想。</p>
<p>首先，我随便选了一个模块通过如下命令去监控其在编译过程中的产物，最终发现在编译过程会生成相关文件，但是在编译快结束的时候所有文件又被删除掉了。</p>
<blockquote>
<p>关于怎么知道监控哪一个路径，参见“What file is used to create tarball”章节日志输出。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 ls -lh apps_proc/chicdk/tmp-glibc/work/aarch64-oe-linux/chicdk/0.1-r0</span><br></pre></td></tr></table></figure>

<p>同时，我也尝试从编译日志去找到一些信息， 然后发现了如下关键信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOTE: recipe chicdk-0.1-r0: task do_rm_work: Started</span><br><span class="line">NOTE: recipe chicdk-0.1-r0: task do_rm_work: Succeeded</span><br></pre></td></tr></table></figure>

<p>通过代码查看对应函数，发现此函数的作用是删掉中间产物，关键部分源码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apps_proc/poky/meta/classes/rm_work.bbclass</span></span><br><span class="line">do_rm_work () &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    cd $&#123;WORKDIR&#125;</span><br><span class="line">    <span class="keyword">for</span> dir <span class="keyword">in</span> *</span><br><span class="line">    do</span><br><span class="line">        <span class="comment"># Retain only logs and other files in temp, safely ignore</span></span><br><span class="line">        <span class="comment"># failures of removing pseudo folers on NFS2/3 server.</span></span><br><span class="line">        <span class="keyword">if</span> [ $dir = <span class="string">&#x27;pseudo&#x27;</span> ]; then</span><br><span class="line">            rm -rf $dir <span class="number">2</span>&gt; /dev/null || true</span><br><span class="line">        <span class="keyword">elif</span> ! echo <span class="string">&quot;$excludes&quot;</span> | grep -q -w <span class="string">&quot;$dir&quot;</span>; then</span><br><span class="line">            rm -rf $dir</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后呢， 我也到 <a target="_blank" rel="noopener" href="https://www.yoctoproject.org/docs/2.5/ref-manual/ref-manual.html#ref-tasks-rm_work">Yocto</a> 官网去查找相关信息，找到了如下描述：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">7.1.25. do_rm_work¶</span><br><span class="line">Removes work files after the OpenEmbedded build system has finished with them. You can learn more by looking at the <span class="string">&quot;rm_work.bbclass&quot;</span> section.</span><br><span class="line"></span><br><span class="line">6.115. rm_work.bbclass¶</span><br><span class="line">The rm_work class supports deletion of temporary workspace, <span class="built_in">which</span> can ease your hard drive demands during builds.</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    INHERIT += <span class="string">&quot;rm_work&quot;</span></span><br><span class="line">...    </span><br><span class="line">Here is an example:</span><br><span class="line">    RM_WORK_EXCLUDE += <span class="string">&quot;busybox glibc&quot;</span></span><br></pre></td></tr></table></figure>

<p>从官方文档上面的内容也顺便找到了解决方案：在 bb 文件或者 local.conf 按照如下方式修改去拒绝删除。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add the following to bb file to prevent removing</span></span><br><span class="line">RM_WORK_EXCLUDE += <span class="string">&quot;$&#123;PN&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or add the following statement which included your module in local.conf</span></span><br><span class="line">RM_WORK_EXCLUDE += <span class="string">&quot;camx chicdk ...&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Still-“No-files-to-create-tarball”"><a href="#Still-“No-files-to-create-tarball”" class="headerlink" title="Still “No files to create tarball”"></a>Still “No files to create tarball”</h2><p>现在预编译包的生成逻辑搞清楚了， 中间产物也保留了， 但是 “No files to create tarball” 问题仍然存在，通过如下代码可以知道，脚本是判断<code>variant_PREBUILT_FILES_ppackage (HY11__PREBUILT_FILES__chicdk)</code> 变量或者说路径下面是否有编译文件存在。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">python do_generate_prebuilt() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># Create prebuilt archive(s)</span></span><br><span class="line">    <span class="keyword">for</span> ppackage <span class="keyword">in</span> ppackages:</span><br><span class="line">        <span class="keyword">for</span> variant <span class="keyword">in</span> pbvariants:</span><br><span class="line">            files = d.getVar(variant + <span class="string">&quot;_PREBUILT_FILES_&quot;</span> + ppackage)</span><br><span class="line">            tarball = <span class="string">&quot;%s/%s_%s_%s_%s.tar&quot;</span> % (prebuiltdatadir, variant, ppackage, pv, arch)</span><br><span class="line">            <span class="comment"># If no file specified quitely quit</span></span><br><span class="line">            <span class="keyword">if</span> files:</span><br><span class="line">                files = files.split()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                bb.debug(<span class="number">1</span>, <span class="string">&quot;No files to create archive %s&quot;</span> %(tarball))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从如下代码逻辑来看，似乎<code>prebuilt</code>的每个环节都没问题都能逻辑自洽，但是为什么不能自动创建预编译包呢？ 由于看不明白<code>do_generate_prebuilt[vardeps] = &quot;$&#123;@gen_prebuiltvar(d)&#125;&quot;</code>这种写法，‘不知道’一律当做高通没做好处理，然后时间紧迫，就选择另一种手动的方式来实现了，稍后会介绍。现在来写总结的时候发现，当时应该多加些日志，尝试把 <code>variant_PREBUILT_FILES_ppackage</code> 变量改为正确的路径试试，或许会更好些， 不过呢，可能意义也不太大，因为后面还有更多<code>半成品</code>的问题遇到。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. apps_proc/poky/meta-qti-bsp-prop/conf/machine/qcs610-odk-64.conf</span></span><br><span class="line"><span class="comment"># Supported prebuilt varaints</span></span><br><span class="line">PREBUILT_VARIANTS = <span class="string">&quot;HY11 HY22&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. apps_proc/poky/meta-qti-bsp-prop/classes/qprebuilt.bbclass</span></span><br><span class="line"><span class="comment"># Default prebuilt package</span></span><br><span class="line">PREBUILT_PACKAGES ?= &quot;$&#123;PN&#125;&quot; # PN means the recipe name.</span><br><span class="line"></span><br><span class="line">gen_prebuiltvar(d):</span><br><span class="line">    ret = []</span><br><span class="line">    ppackages = (d.getVar(<span class="string">&quot;PREBUILT_PACKAGES&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).split()</span><br><span class="line">    pbvariants = (d.getVar(<span class="string">&quot;PREBUILT_VARIANTS&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).split()</span><br><span class="line">    <span class="comment"># e.g. HY11_PREBUILT_PACKAGES, HY22_PREBUILT_PACKAGES</span></span><br><span class="line">    <span class="keyword">for</span> variant <span class="keyword">in</span> pbvariants:</span><br><span class="line">        ret.append(variant + <span class="string">&quot;_PREBUILT_PACKAGES&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># e.g. HY11_PREBUILT_FILES_&lt;package&gt;</span></span><br><span class="line">    <span class="keyword">for</span> ppackage <span class="keyword">in</span> ppackages:</span><br><span class="line">        <span class="keyword">for</span> variant <span class="keyword">in</span> pbvariants:</span><br><span class="line">            ret.append(variant + <span class="string">&quot;_PREBUILT_FILES_&quot;</span> + ppackage)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; &quot;</span>.join(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate Prebuilt tarball</span></span><br><span class="line">do_generate_prebuilt[doc] = <span class="string">&quot;Create a prebuilt package&quot;</span></span><br><span class="line">do_generate_prebuilt[vardeps] = <span class="string">&quot;$&#123;@gen_prebuiltvar(d)&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">python do_generate_prebuilt() &#123;</span><br><span class="line">    files = d.getVar(variant + <span class="string">&quot;_PREBUILT_FILES_&quot;</span> + ppackage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="“from-chicdk-was-already-stripped”"><a href="#“from-chicdk-was-already-stripped”" class="headerlink" title="“from chicdk was already stripped”"></a>“from chicdk was already stripped”</h2><p>免费赠送一个警告消除，有点强迫症和精神洁癖，所以有些小东西如果不整透彻，心里会增加小疙瘩，譬如如下日志。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: chicdk-0.1-r0 do_package: QA Issue: File <span class="string">&#x27;/usr/lib/rfsa/adsp/libdsp_streamer_binning.so&#x27;</span> from chicdk was already stripped, this will prevent future debugging! [already-stripped]</span><br></pre></td></tr></table></figure>

<p>本着心里小疙瘩能少则少的原则，调查一番后，发现在<code>local.conf</code>中添加<code>INSANE_SKIP_$&#123;PN&#125;_append = “already-stripped”</code>可以消除此警告。<code>$&#123;PN&#125;</code>代表报名，即 bb 文件名。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSANE_SKIP_chicdk_append = <span class="string">&quot;already-stripped&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Prepare-prebuilt-package"><a href="#Prepare-prebuilt-package" class="headerlink" title="Prepare prebuilt package"></a>Prepare prebuilt package</h2><h3 id="Script-to-package"><a href="#Script-to-package" class="headerlink" title="Script to package"></a>Script to package</h3><p>既然高通已有的东西不足以成功生成预编译包，我就选择自己准备脚本根据代码逻辑去创建预编译包。脚本内容如下, 将此脚本放置于 “non-stripped” 或者 “stripped” 路径，执行即可创建与编译包，然后执行如下最后两步，此部分源码 SDK 化即完成了。</p>
<ul>
<li>将预编译包放到<code>apps_proc/prebuilt_HY11</code>路径下；</li>
<li>删除源码。<blockquote>
<p>关于选择 “non-stripped” 还是 “stripped” 路径来打包这个问题， 个人理解，如果是做需要再次开发的 SDK，或许 “non-stripped” 更为合适。</p>
</blockquote>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create_prebuilt_targz.sh</span></span><br><span class="line"><span class="comment"># create tarball</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that PWD should be in subdir prebuilt/non-stripped/ of recipe WORKDIR</span></span><br><span class="line"><span class="comment"># e.g: apps_proc/build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/work/aarch64-oe-linux/libgpt/1.0-r0/prebuilt/stripped/</span></span><br><span class="line"><span class="comment"># If we want to put this script into &quot;stripped&quot;, we need to modify the following if condition.</span></span><br><span class="line"><span class="keyword">function</span> check_pwd()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(basename $PWD)</span>&quot;</span> != <span class="string">&quot;non-stripped&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;please change into subdir prebuilt/stripped/ of recipe WORKDIR&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> get_targz_name()</span><br><span class="line">&#123;</span><br><span class="line">    WORKDIR=<span class="variable">$&#123;PWD/prebuilt*/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> WORKDIR=<span class="variable">$WORKDIR</span></span><br><span class="line"></span><br><span class="line">    PV_BASE=$(basename <span class="variable">$WORKDIR</span>)</span><br><span class="line">    PV=<span class="variable">$&#123;PV_BASE/-*/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> PV=<span class="variable">$PV</span></span><br><span class="line">    PN_DIR=$(dirname <span class="variable">$WORKDIR</span>)</span><br><span class="line">    PN=$(basename <span class="variable">$PN_DIR</span>)</span><br><span class="line">    <span class="built_in">echo</span> PN=<span class="variable">$&#123;PN&#125;</span></span><br><span class="line">    PACKAGE_ARCH_DIR=$(dirname <span class="variable">$&#123;PN_DIR&#125;</span>)</span><br><span class="line">    PACKAGE_ARCH_BASE=$(basename <span class="variable">$&#123;PACKAGE_ARCH_DIR&#125;</span>)</span><br><span class="line">    PACKAGE_ARCH=<span class="variable">$&#123;PACKAGE_ARCH_BASE/-oe-linux/&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> PACKAGE_ARCH=<span class="variable">$PACKAGE_ARCH</span></span><br><span class="line">    PREBUILT_TARGZ_NAME=<span class="variable">$&#123;PN&#125;</span>_<span class="variable">$&#123;PV&#125;</span>_<span class="variable">$&#123;PACKAGE_ARCH&#125;</span>.tar.gz</span><br><span class="line">    <span class="built_in">echo</span> PREBUILT_TARGZ_NAME=<span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_pwd</span><br><span class="line"><span class="built_in">echo</span> OK</span><br><span class="line">get_targz_name</span><br><span class="line">tar cvfz <span class="variable">$&#123;PREBUILT_TARGZ_NAME&#125;</span> *</span><br></pre></td></tr></table></figure>

<p>删除源码的时候， 有时会遇到如下的编译错误，这是因为其他模块对此模块的某些文件有依赖， 遇到这种情况只需要将对应文件保留即可。被依赖的文件一般是解释性脚本文件或者 API 库的头文件，保留不会影响 SDK 的闭源动作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python: can<span class="string">&#x27;t open file &#x27;</span>/home/.../apps_proc/src/vendor/qcom/proprietary/chi-cdk/tools//buildbins/buildbins.py<span class="string">&#x27;: [Errno 2] No such file or directory</span></span><br><span class="line"><span class="string">camxlib/0.1-r0/temp/run.do_autogen.5102:1 exit 1 from &#x27;</span>python /home/.../apps_proc/src/vendor/qcom/proprietary/chi-cdk/tools//buildbins/buildbins.py --target=code --gen-code-dir=/home/.../apps_proc/src/vendor/qcom/proprietary/chi-cdk/api//generated/<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>本以为，从此就顺风顺水，天随人愿，大功告成了，可惜现实反手又是一记响亮的耳光。很多模块并没有明确的依赖关系以及 “non-stripped” 或者 “stripped” 产物，而是各种分离的文件系统置于编译输出目录的不同路径。</p>
<h3 id="Purely-manual-copy"><a href="#Purely-manual-copy" class="headerlink" title="Purely manual copy"></a>Purely manual copy</h3><p>仰望着<code>Ycoto</code>陡峭的学习曲线，以及闭源源码仓库的各种复杂依赖关系，再加上时间紧迫，我放弃了理清编译系统的处理方式然后修复它们，而是懒惰地选择了手动拷贝并打包对应的文件。</p>
<h4 id="Find-the-bb-files"><a href="#Find-the-bb-files" class="headerlink" title="Find the bb files"></a>Find the bb files</h4><p>第一步是找到对应模块的 bb 文件，一般通过所有源码所在路径可以找到其对应的 bb 文件（即模块名），通过模块名则可以推测出预编译包的名字。但是更多的时候，由于依赖关系，以及某一路径下面的源码被多个模块使用的情况存在，比较快速的一个确认方式是：直接将对应的源码删掉，然后根据日志找出所有的 bb 文件名。</p>
<h4 id="Get-the-accurate-tarball-name-from-log"><a href="#Get-the-accurate-tarball-name-from-log" class="headerlink" title="Get the accurate tarball name from log"></a>Get the accurate tarball name from log</h4><p>当对预编译包的名字不确定时，我们可以在编译日志中找到对应模块的预编译包名，譬如 <code>sensors-see</code> 在编译日志中打印的预编译包名如下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sensors-see-qti_git.bb: Looking <span class="keyword">for</span>: /home/.../apps_proc/prebuilt_HY11/`sensors-see-qti_git_aarch64.tar.gz`</span><br></pre></td></tr></table></figure>

<h4 id="Get-prebuilt-files"><a href="#Get-prebuilt-files" class="headerlink" title="Get prebuilt files"></a>Get prebuilt files</h4><p>除了少数模块可以生成 “non-stripped” 和 “stripped” 目录外，大部分模块并没有明显的预编译产物。针对这种情况，目前发现的比较快捷的方式主要有两种：</p>
<ul>
<li>从 Deb 中解压</li>
<li>从编译目录里面找到其对应文件</li>
</ul>
<p>然后再拷贝对应的 license 文件夹并命名 <strong>LIC</strong>, 最后一起打包为预编译包，以 <code>sensors-see</code> 为例总结如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Get files based on one of the two following ways</span></span><br><span class="line">ar vx sensors-see-qti_0-r0_arm64.deb</span><br><span class="line">tar -xvf data.tar.xz -C data/</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">cp build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/sysroots-components/aarch64/sensors-see-qti/* data/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Get licenses</span></span><br><span class="line">cp build-qti-distro-ubuntu-fullstack-debug/tmp-glibc/deploy/licenses/sensors-see-qti data/__LIC__</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Make tarball</span></span><br><span class="line">tar -cjvf sensors-see-qti_git_aarch64.tar.gz data/*</span><br></pre></td></tr></table></figure>

<h3 id="Build-from-prebuilt-package"><a href="#Build-from-prebuilt-package" class="headerlink" title="Build from prebuilt package"></a>Build from prebuilt package</h3><p>按照如上方式准备预编译包后，大部分模块都能成功地工作，之前取预编译包，不再编译源码，但是少部分模块会继续编译源码并报错。针对报错的模块，我们需要修改其 bb 文件，按照如下方式去继承 <code>qprebuilt</code> 类。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inherit qprebuilt</span><br></pre></td></tr></table></figure>

<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Okay， 谢谢阅读。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/01/Life/2022_start/" rel="prev" title="Hello 2022 lately">
      <i class="fa fa-chevron-left"></i> Hello 2022 lately
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/10/25/PDF01/" rel="next" title="Virtualization vs Containerization">
      Virtualization vs Containerization <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#What-does-SDK-mean-in-current-context"><span class="nav-number">1.</span> <span class="nav-text">What does SDK mean in current context?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-to-make-SDK-based-on-Yocto-build-system"><span class="nav-number">2.</span> <span class="nav-text">How to make SDK based on Yocto build system</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Prebuilt-tarball"><span class="nav-number">2.1.</span> <span class="nav-text">Create Prebuilt tarball</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-deb-directly"><span class="nav-number">2.2.</span> <span class="nav-text">Install deb directly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compile-and-replace-with-binary"><span class="nav-number">2.3.</span> <span class="nav-text">Compile and replace with binary</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lessons-and-Gains-of-making-prebuilt-sdk"><span class="nav-number">3.</span> <span class="nav-text">Lessons and Gains of making prebuilt sdk</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Locating-problem-with-enhanced-log"><span class="nav-number">3.1.</span> <span class="nav-text">Locating problem with enhanced log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#No-files-to-create-tarball"><span class="nav-number">3.2.</span> <span class="nav-text">No files to create tarball</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#do-generate-prebuilt"><span class="nav-number">3.3.</span> <span class="nav-text">do_generate_prebuilt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-file-is-used-to-create-tarball"><span class="nav-number">3.4.</span> <span class="nav-text">What file is used to create tarball</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-%E2%80%98D%E2%80%99"><span class="nav-number">3.5.</span> <span class="nav-text">What is ‘D’</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-the-file-required-by-tarball-does-not-exist"><span class="nav-number">3.6.</span> <span class="nav-text">Why the file required by tarball does not exist</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Still-%E2%80%9CNo-files-to-create-tarball%E2%80%9D"><span class="nav-number">3.7.</span> <span class="nav-text">Still “No files to create tarball”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%9Cfrom-chicdk-was-already-stripped%E2%80%9D"><span class="nav-number">3.8.</span> <span class="nav-text">“from chicdk was already stripped”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prepare-prebuilt-package"><span class="nav-number">3.9.</span> <span class="nav-text">Prepare prebuilt package</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Script-to-package"><span class="nav-number">3.9.1.</span> <span class="nav-text">Script to package</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Purely-manual-copy"><span class="nav-number">3.9.2.</span> <span class="nav-text">Purely manual copy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Find-the-bb-files"><span class="nav-number">3.9.2.1.</span> <span class="nav-text">Find the bb files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Get-the-accurate-tarball-name-from-log"><span class="nav-number">3.9.2.2.</span> <span class="nav-text">Get the accurate tarball name from log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Get-prebuilt-files"><span class="nav-number">3.9.2.3.</span> <span class="nav-text">Get prebuilt files</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Build-from-prebuilt-package"><span class="nav-number">3.9.3.</span> <span class="nav-text">Build from prebuilt package</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Andy.Lee"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Andy.Lee</p>
  <div class="site-description" itemprop="description">Just need to enjoy life.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huaqianlee" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:huaqianlee@gmail.com" title="E-Mail → mailto:huaqianlee@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/huaqianlee" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/huaqianlee" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/huaqianlee" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/huaqianlee" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://huaqianlee.github.io/" title="http:&#x2F;&#x2F;huaqianlee.github.io&#x2F;">Andy.Lee's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://huaqianlee.me/" title="http:&#x2F;&#x2F;huaqianlee.me&#x2F;" rel="noopener" target="_blank">Andy.Lee's Cabin</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andy.Lee</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'af176630d44392cdef8f',
      clientSecret: '63681992881b6f3ecd24146470e5aaf7d068fe14',
      repo        : 'huaqianlee.github.io',
      owner       : 'huaqianlee',
      admin       : ['huaqianlee'],
      id          : 'cdd737be89288566fd0d4d4e19a9880a',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
