<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Arial:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"huaqianlee.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":"ture","color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Android 源码分析系列综述博文： Android 系统源码分析综述  Platform information： MTK6797（X20）+ Android 7.0 之前做高通的时候，对高通此部分做过粗略的分析，不过当时胡乱做的些笔记，只简单整理了几篇博客，感兴趣可以参考如下路径： 高通平台Android源码bootloader分析之sbl1(一) 高通平台Android源码bootloa">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 电源管理之电池管理系统(BMS)">
<meta property="og:url" content="http://huaqianlee.github.io/2017/11/21/Android/BMS-of-Android-Power-Management/index.html">
<meta property="og:site_name" content="Andy.Lee&#39;s  Blog">
<meta property="og:description" content="Android 源码分析系列综述博文： Android 系统源码分析综述  Platform information： MTK6797（X20）+ Android 7.0 之前做高通的时候，对高通此部分做过粗略的分析，不过当时胡乱做的些笔记，只简单整理了几篇博客，感兴趣可以参考如下路径： 高通平台Android源码bootloader分析之sbl1(一) 高通平台Android源码bootloa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/chargind_state.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtkGauge_arch.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/battery%20introduction.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/kernel_cod_arch.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/charging_control.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/bat_update_func.jpg">
<meta property="og:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging2.jpg">
<meta property="article:published_time" content="2017-11-21T13:56:28.000Z">
<meta property="article:modified_time" content="2019-04-06T14:25:27.038Z">
<meta property="article:author" content="Andy.Lee">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="MTK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/chargind_state.jpg">

<link rel="canonical" href="http://huaqianlee.github.io/2017/11/21/Android/BMS-of-Android-Power-Management/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Android 电源管理之电池管理系统(BMS) | Andy.Lee's  Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Andy.Lee's  Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Good good study, day day up !</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">107</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">14</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">28</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://huaqianlee.github.io/2017/11/21/Android/BMS-of-Android-Power-Management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy.Lee">
      <meta itemprop="description" content="Just need to enjoy life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Andy.Lee's  Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android 电源管理之电池管理系统(BMS)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Nov 21 2017 21:56:28" itemprop="dateCreated datePublished" datetime="2017-11-21T21:56:28+08:00">Nov 21 2017</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Apr 6 2019 22:25:27" itemprop="dateModified" datetime="2019-04-06T22:25:27+08:00">Apr 6 2019</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>Android 源码分析系列综述博文： <a href="http://huaqianlee.github.io/2100/11/21/Android/A-summary-of-Android-source-analysis/">Android 系统源码分析综述</a></p>
</blockquote>
<p><em>Platform information： MTK6797（X20）+ Android 7.0</em></p>
<p>之前做高通的时候，对高通此部分做过粗略的分析，不过当时胡乱做的些笔记，只简单整理了几篇博客，感兴趣可以参考如下路径：</p>
<p><a href="http://huaqianlee.github.io/2015/08/15/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%B8%80/">高通平台Android源码bootloader分析之sbl1(一)</a></p>
<p><a href="http://huaqianlee.github.io/2015/08/15/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%BA%8C/">高通平台Android源码bootloader分析之sbl1(二)</a></p>
<p><a href="http://huaqianlee.github.io/2015/08/18/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%B8%89/">高通平台Android源码bootloader分析之sbl1(三)</a></p>
<p><a href="http://huaqianlee.github.io/2015/01/21/Android/%E9%AB%98%E9%80%9AAndroid%E4%B8%8D%E5%B8%A6%E7%94%B5%E9%87%8F%E8%AE%A1%E7%9A%84%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E6%96%B9%E5%BC%8F/">Android不带电量计的电量计算</a></p>
<p><a href="http://huaqianlee.github.io/2015/05/30/Android/Android%E7%94%B5%E6%BA%90%E7%AE%A1%E7%90%86%E6%9E%B6%E6%9E%84/">Android 电源管理架构</a></p>
<p><a href="http://huaqianlee.github.io/2015/06/06/Android/Android%E7%94%B5%E6%B1%A0%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F-BMS-%E4%B9%8B%E7%94%B5%E6%B1%A0%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">Android电池监控系统-BMS-之电池系统架构 (有坑未填)</a></p>
<p><a href="http://huaqianlee.github.io/2015/06/24/Android/qaulcomm-bms-driver-analysis/">高通电池管理系统（BMS）驱动分析</a></p>
<p><a href="http://huaqianlee.github.io/2015/06/24/Android/smb135x-charger-driver/">高通 smb135x charger 驱动分析</a></p>
<p><a href="http://huaqianlee.github.io/2015/06/24/Android/qcom-pmic-driver/">高通 PMIC 架构简析</a></p>
<p><a href="http://huaqianlee.github.io/2015/06/24/Android/linear-charger-driver/">高通 linear charger 驱动分析</a></p>
<h1 id="充电简析"><a href="#充电简析" class="headerlink" title="充电简析"></a>充电简析</h1><h2 id="充电状态机"><a href="#充电状态机" class="headerlink" title="充电状态机"></a>充电状态机</h2><p>电池充电过程分为预充、恒流充电（CC模式）、恒压充电（CV模式）、涓流充电四个流程，MTK的状态机如下：</p>
<p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/chargind_state.jpg" alt="state"></p>
<a id="more"></a>
<h2 id="充电简要流程框图"><a href="#充电简要流程框图" class="headerlink" title="充电简要流程框图"></a>充电简要流程框图</h2><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtkGauge_arch.jpg" alt="flow"></p>
<h1 id="BMS-架构"><a href="#BMS-架构" class="headerlink" title="BMS 架构"></a>BMS 架构</h1><p>MTK 的 BMS 架构如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/battery%20introduction.jpg" alt="bms"></p>
<p>我准备将BMS从硬件到APP分为不同的架构层来分析。接下来分别分析下不同的架构层。</p>
<h2 id="硬件层"><a href="#硬件层" class="headerlink" title="硬件层"></a>硬件层</h2><p>硬件层主要分为三个部分：PMIC，Fuel Gauge 和 ADC。本文主要分析软件，所以硬件就不准备深入研究了。</p>
<h3 id="1-1-1-PMIC"><a href="#1-1-1-PMIC" class="headerlink" title="1.1.1 PMIC"></a>1.1.1 PMIC</h3><p>智能手机方案一般都会有一个PMIC芯片，有些也还会采用外接充电IC，使不使用外接IC，软件驱动会有一些区别。</p>
<h3 id="Fuel-Gauge"><a href="#Fuel-Gauge" class="headerlink" title="Fuel Gauge"></a>Fuel Gauge</h3><p>Fuel Gauge 是 MTK 为充放电、电量算法提供服务的一个硬件电路，电路中的电阻比较重要。</p>
<h3 id="ADC"><a href="#ADC" class="headerlink" title="ADC"></a>ADC</h3><p>FGADC 和 AUXADC 分别采样电池的电流、电压（还会采样电池温度）。</p>
<h2 id="BootLoader层"><a href="#BootLoader层" class="headerlink" title="BootLoader层"></a>BootLoader层</h2><p>BootLoader部分没有在上图表现出来，也可以将其归为driver部分。</p>
<h3 id="1-2-1-Preloader层"><a href="#1-2-1-Preloader层" class="headerlink" title="1.2.1 Preloader层"></a>1.2.1 Preloader层</h3><p>此部分会对充电做一些初始设置，比如设置手机尽早开始充电以避免电池低电压不能进入接下来的充电状态，关键路径如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alps\vendor\mediatek\proprietary\bootable\bootloader\preloader\platform\mt6797\src\drivers\platform.c</span><br></pre></td></tr></table></figure>

<h3 id="LK层"><a href="#LK层" class="headerlink" title="LK层"></a>LK层</h3><p>此部分主要针对充电主要做三件事：1. 启动方式、充电状态监测；2. 初始化充电IC；3. 充电器状态监测处理。</p>
<h4 id="启动方式、充电状态监测"><a href="#启动方式、充电状态监测" class="headerlink" title="启动方式、充电状态监测"></a>启动方式、充电状态监测</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\<span class="meta-keyword">include</span>\platform\boot_mode.h</span></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\boot_mode.c</span></span><br><span class="line">boot_mode_select() <span class="comment">// 启动方式判断及处理</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\platform.c</span></span><br><span class="line">platform_init() &#123;</span><br><span class="line">    upmu_is_chr_det() <span class="comment">// 充电检测，Unplugged则关机</span></span><br><span class="line">    <span class="keyword">if</span> (kernel_charging_boot() == <span class="number">1</span>) &#123; <span class="comment">// 充电启动，显示关机充电信息</span></span><br><span class="line">        <span class="comment">/*判断充电设备和状态，显示充电图标和点亮充电指示灯*/</span></span><br><span class="line">        mt_disp_power(TRUE);</span><br><span class="line">		mt_disp_show_low_battery();</span><br><span class="line">		mt65xx_leds_brightness_set(<span class="number">6</span>, <span class="number">110</span>);</span><br><span class="line">    &#125;<span class="comment">// 否则，闹钟启动灯其他方式启动，显示开机界面</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">boot_mode_select(); <span class="comment">// 区分开机过程</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\mt_kernel_power_off_charging.c</span></span><br><span class="line">set_off_mode_charge_status()</span><br><span class="line">kernel_power_off_charging_detection(<span class="keyword">void</span>) &#123; <span class="comment">// 充电状态监测</span></span><br><span class="line">    get_off_mode_charge_status()</span><br><span class="line">	<span class="keyword">if</span> (upmu_is_chr_det() == KAL_TRUE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (off_mode_status) &#123;</span><br><span class="line">			g_boot_mode = KERNEL_POWER_OFF_CHARGING_BOOT;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			g_boot_mode = NORMAL_BOOT;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mt6575_power_off();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="初始化充电IC"><a href="#初始化充电IC" class="headerlink" title="初始化充电IC"></a>初始化充电IC</h4><p>充电IC的初始化工作，有些可以被kernel驱动覆盖，有些不能，所以有时候一些修改记得在LK和kernel里面都得完成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\mt_battery.c</span></span><br><span class="line">pchr_turn_on_charging() &#123; <span class="comment">//打开充电</span></span><br><span class="line">	bq25890_hw_init();</span><br><span class="line">	bq25890_charging_enable(bEnable);</span><br><span class="line">	bq25890_dump_register();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\rules.mk</span></span><br><span class="line">    ifeq ($(MTK_BQ25896_SUPPORT),yes)</span><br><span class="line">      OBJS +=$(LOCAL_DIR)/bq25890.o</span><br><span class="line">      DEFINES += MTK_BQ25896_SUPPORT</span><br><span class="line">      DEFINES += SWCHR_POWER_PATH</span><br><span class="line"></span><br><span class="line"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\include\platform\bq25890.h</span><br><span class="line"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\bq25890.c</span><br><span class="line"><span class="keyword">void</span> bq25890_hw_init(<span class="keyword">void</span>)</span><br><span class="line"># 充电IC初始化及电流电压等相关设置</span><br></pre></td></tr></table></figure>
<h4 id="1-2-2-3-充电器状态监测处理"><a href="#1-2-2-3-充电器状态监测处理" class="headerlink" title="1.2.2.3 充电器状态监测处理"></a>1.2.2.3 充电器状态监测处理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\app\mt_boot\mt_boot.c</span></span><br><span class="line">boot_linux_fdt() &#123;</span><br><span class="line">    <span class="keyword">if</span> (kernel_charging_boot() == <span class="number">-1</span>) </span><br><span class="line">    	mt6575_power_off(); <span class="comment">// if Unplugged, 关机</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kernel_charging_boot() == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pmic_detect_powerkey()) &#123;</span><br><span class="line">			mtk_arch_reset(<span class="number">1</span>); <span class="comment">// 跳转kernel前如果按键，重启</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="充电图标"><a href="#充电图标" class="headerlink" title="充电图标"></a>充电图标</h4><p>MTK之前很多方案是在lk里面绘制关机充电图标，然后采样IPO协议实现关机充电。不过现在已采取高通类似方案在Health部分绘制关机充电图标了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6755\mt_logo.c</span></span><br></pre></td></tr></table></figure>
<p>IPO方式流程图如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging.jpg" alt="IPO"></p>
<blockquote>
<p>由于初次接触MTK，又没有深入研究此部分，此部分如有错误，敬请谅解和指出。</p>
</blockquote>
<h2 id="Kernel层"><a href="#Kernel层" class="headerlink" title="Kernel层"></a>Kernel层</h2><p>Kernel 部分软件流程框图，不过此图是我从MTK文档上截取没有做修改，所以图片中外部充电IC代码为Fan5405，对应于我的代码应该为bq24290（bq24296）。如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/kernel_cod_arch.jpg" alt="arch"></p>
<h3 id="1-3-1-ADC部分"><a href="#1-3-1-ADC部分" class="headerlink" title="1.3.1 ADC部分"></a>1.3.1 ADC部分</h3><p>电流电压采样部分代码没有深入查看，主要看了如下一个文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\pmic_auxadc.c</span></span><br><span class="line">pmic_auxadc_init()</span><br><span class="line">PMIC_IMM_GetCurrent <span class="comment">// 算出电流</span></span><br></pre></td></tr></table></figure>

<h3 id="HAL部分"><a href="#HAL部分" class="headerlink" title="HAL部分"></a>HAL部分</h3><p>此 HAL 并不是真正的 HAL 层，实际是驱动部分，实现部分结构体，针对 MTK 不同充电方案提供支持，读取各项参数。我所阅读的代码使用了外接充电 IC BQ24296（switch charger），驱动不会走 linear_charging.c，走 switch_charging.c + bq25896 驱动部分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\charging_hw_pmic.c</span></span><br><span class="line">charging_value_to_parameter()</span><br><span class="line">charging_parameter_to_value()</span><br><span class="line">charging_hw_init() <span class="comment">// PMIC初始化</span></span><br><span class="line">charging_get/set_current()</span><br><span class="line">charging_sw_init()</span><br><span class="line">chr_control_interface()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_meter_hal.h</span></span><br><span class="line">BATTERY_METER_CTRL_CMD</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\battery_meter_hal.c</span></span><br><span class="line">get_hw_ocv</span><br><span class="line">read_adc_v_bat_sense()  <span class="comment">// 读取电池电压，根据宏判断 batsense 还是 isense</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\bq25890.h</span></span><br><span class="line"><span class="comment">// 硬件定义及接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\bq25890.c</span></span><br><span class="line">bq25890_driver_probe() <span class="comment">// 注册驱动</span></span><br><span class="line">bq25890_get_xx() <span class="comment">// get 接口</span></span><br><span class="line">bq25890_set_xx() <span class="comment">// set 接口</span></span><br><span class="line">bq25890_hw_init() </span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\charging_hw_bq25890.c</span></span><br><span class="line">is_chr_det() <span class="comment">// 充电器检测</span></span><br><span class="line">    val = pmic_get_register_value(MT6351_PMIC_RGS_CHRDET);</span><br><span class="line">charging_hw_init() <span class="comment">// 充电IC初始化     </span></span><br><span class="line">charging_sw_init() <span class="comment">// 充电IC初始化</span></span><br><span class="line">charging_get_xx() <span class="comment">// 封装后的 get 接口</span></span><br><span class="line">charging_get_charger_type() <span class="comment">// 获取充电器类型</span></span><br><span class="line">charging_set_xx() <span class="comment">// 封装后的 set 接口</span></span><br><span class="line">charging_set_current() <span class="comment">// 设置充电电流</span></span><br></pre></td></tr></table></figure>

<h3 id="Common部分"><a href="#Common部分" class="headerlink" title="Common部分"></a>Common部分</h3><p>PMIC充电控制、充电控制主线程、SW FG算法等内容在此部分实现。battery_common*.c 是一个关键文件，其是充电控制的主线程，battery 设备也由此文件注册。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\charging.h</span></span><br><span class="line">CHARGING_CTRL_CMD</span><br><span class="line">CHARGER_TYPE</span><br><span class="line">BATTERY_VOLTAGE_ENUM</span><br><span class="line">CHR_CURRENT_ENUM</span><br><span class="line"><span class="comment">// 如上等电池相关宏定义</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_common.h</span></span><br><span class="line"><span class="comment">// 充电等相关参数定义</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps/kernel-3.18/drivers/power/mediatek/battery_common_fg_20.c </span></span><br><span class="line"><span class="comment">// 充电控制主线程</span></span><br><span class="line">power_supply_property xx <span class="comment">// 定义电池相关文件节点，后面接口函数对其更新</span></span><br><span class="line">upmu_is_chr_det() <span class="comment">// 充电状态监测</span></span><br><span class="line">wireless/ac/usb_get_get_property() <span class="comment">// 更新 charger</span></span><br><span class="line">battery_update() </span><br><span class="line">bat_routine_thread()</span><br><span class="line">    hrtimer_start() <span class="comment">// 开始定时器，定时更新数据</span></span><br><span class="line">battery_init() <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_meter.h</span></span><br><span class="line"><span class="comment">// SW FG 算法相关定义</span></span><br><span class="line"><span class="meta"># alps/kernel-3.18/drivers/power/mediatek/battery_meter_fg_20.c </span></span><br><span class="line"><span class="comment">// SW FG算法,也即是OAM</span></span><br><span class="line">SW FG的原理：</span><br><span class="line">a.PMIC adc来获取raw vbat电压。</span><br><span class="line">b.通过ZCV表格，将vbat转换成OCV</span><br><span class="line">c.ocv-vbat/r 来获取电流I</span><br><span class="line">d.对电流i 进行积分，获取电量。</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MTK vendor 封装了 FG2.0 算法，计算soc，然后通过netlink发送到Kernel</span></span><br><span class="line"><span class="comment"> * 算法部分可以参考FG1.0的代码（battery_meter.c）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BMT_status.SOC = battery_meter_get_battery_percentage()</span><br><span class="line">  gFG_capacity_by_c <span class="comment">//库仑计计算的电量值</span></span><br><span class="line">    bmd_ctrl_cmd_from_user（）<span class="comment">// meter  数据</span></span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;gFG_capacity_by_c,...)</span><br><span class="line">        nl_data_handler（）-&gt;data = NLMSG_DATA(nlh)</span><br><span class="line"></span><br><span class="line">D0值：读取电池电压，将电池电压按对应电池的ZCV表查找对应的百分比，根据一定算法运算出的初始电量。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\power\mediatek\linear_charging.c</span><br><span class="line"><span class="comment">// PMIC充电控制， CC模式CV模式切换</span></span><br><span class="line">mtk_tuning_voltage()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*linear_charging.c 和 switch_charging.c二选一*/</span></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\power\mediatek\switch_charging.c</span><br><span class="line"><span class="comment">// SW charger充电控制， CC模式CV模式切换</span></span><br><span class="line">set_chr_input_current_limit()</span><br><span class="line">set_bat_sw_cv_charging_current_limit()</span><br><span class="line">...</span><br><span class="line">charging_full_check()</span><br><span class="line"></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\misc\mediatek\power\mt6797\pmic_chr_type_det.c</span><br></pre></td></tr></table></figure>
<p>Fuel Gauge Control 和 Charging Control 框图如下：</p>
<p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/charging_control.jpg" alt="FG&amp;Charging Control"></p>
<h3 id="客制化部分"><a href="#客制化部分" class="headerlink" title="客制化部分"></a>客制化部分</h3><p>不同于高通将电池曲线合入DTS，MTK是以头文件的形式合入电池曲线（好像也有DTS方式）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_battery_meter_table.h</span></span><br><span class="line"><span class="comment">// 充电IC温度检测上拉电阻配置</span></span><br><span class="line">BATTERY_PROFILE_STRUCT battery_profile_tx[] <span class="comment">// 合入不同温度下电池曲线的 DOD OCV</span></span><br><span class="line">R_PROFILE_STRUCT r_profile_t1[] <span class="comment">// 合入不同温度下电池曲线的电池内阻和OCV</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_battery_meter.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_BY_HW_FG  <span class="comment">// 定义默认使用 Fuel Gauge， FG算法</span></span></span><br><span class="line"><span class="comment">/*#define HW_FG_FORCE_USE_SW_OCV*/</span></span><br><span class="line"><span class="comment">/*#define SOC_BY_SW_FG*/</span></span><br><span class="line"><span class="comment">// 电池参数配置，部分值来源于电池曲线表</span></span><br><span class="line">CUST_POWERON_DELTA_CAPACITY_TOLRANCE <span class="comment">// 重启电量记录范围</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_charging.h</span></span><br><span class="line"><span class="comment">// 充电控制，充电电流、温度等宏定义</span></span><br></pre></td></tr></table></figure>

<h3 id="文件节点"><a href="#文件节点" class="headerlink" title="文件节点"></a>文件节点</h3><p>电池状态、充电状态等文件节点的创建路径：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Power Supply Class Node </span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply.h</span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_core.c</span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_sysfs.c</span></span><br><span class="line">power_supply_show_property()</span><br><span class="line">power_supply_attrs</span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_leds.c</span></span><br></pre></td></tr></table></figure>

<h3 id="Healthd模块"><a href="#Healthd模块" class="headerlink" title="Healthd模块"></a>Healthd模块</h3><p>Healtdh模块是一个单独的进程，这部分主要做两件事：1. 读取电池数据，上报（BatteryService.java）； 2. 绘制关机图标。</p>
<h4 id="Main函数"><a href="#Main函数" class="headerlink" title="Main函数"></a>Main函数</h4><p>healthd.cpp是Healthd模块的入口，也就是Main函数，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\system\core\healthd\healthd.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 针对不同方式定义执行函数</span></span><br><span class="line"><span class="comment"> * android_ops  正常开机</span></span><br><span class="line"><span class="comment"> * charger_ops  关机充电</span></span><br><span class="line"><span class="comment"> * recovery_ops Recovery模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">healthd_mode_ops</span> <span class="title">android_ops</span> = &#123;</span></span><br><span class="line">    .init = healthd_mode_android_init,</span><br><span class="line">    .preparetowait = healthd_mode_android_preparetowait,</span><br><span class="line">    .heartbeat = healthd_mode_nop_heartbeat,</span><br><span class="line">    .battery_update = healthd_mode_android_battery_update,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">uevent_event() <span class="comment">// uevent 事件处理</span></span><br><span class="line">    uevent_kernel_multicast_recv(uevent_fd, msg, UEVENT_MSG_LEN) <span class="comment">// 接收底层事件，并返回事件数量</span></span><br><span class="line">    <span class="comment">/*遍历事件，POWER_SUPPLY_SUBSYSTEM*/</span></span><br><span class="line">    healthd_battery_update() <span class="comment">// 电池信息更新入口，此处根据返回 Charging ？，设置 poll 唤醒周期</span></span><br><span class="line">        gBatteryMonitor-&gt;update()   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main() <span class="comment">// main函数,单独的进程</span></span><br><span class="line">    healthd_mode_ops = &amp;android_ops/&amp;charger_ops/&amp;recovery_ops; <span class="comment">// 选择执行函数体</span></span><br><span class="line">    healthd_init</span><br><span class="line">        epoll_create(MAX_EPOLL_EVENTS); <span class="comment">// 使用epoll进行IO复用, 在一个线程管理所以 fd</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 创建、注册监听三个事件，加入 epoll fd，每个事件都有其句柄函数</span></span><br><span class="line"><span class="comment">         * gBinderfd ：监听Binder通信事件，句柄：binder_event（healthd_mode_android.cpp）</span></span><br><span class="line"><span class="comment">         * uevent_fd： 监听底层电池 event，句柄:uevent_event()</span></span><br><span class="line"><span class="comment">         * wakealarm_fd：监听wakealarm事件，句柄：wakealarm_event</span></span><br><span class="line"><span class="comment">         * 在监听到事件后，epoll 就会在句柄函数里面做相应的更新操作，如上 uevent_event()</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        healthd_mode_ops-&gt;init(&amp;healthd_config)<span class="comment">// healthd_mode_android_init()</span></span><br><span class="line">        uevent_init()</span><br><span class="line">        wakealarm_init()</span><br><span class="line">        <span class="keyword">new</span> BatteryMonitor();</span><br><span class="line">    healthd_mainloop(); <span class="comment">// main函数，while(1) </span></span><br><span class="line">        <span class="keyword">if</span> (events[n].data.ptr) <span class="comment">// epoll遍历事件fd，调用处理函数</span></span><br><span class="line">                (*(<span class="keyword">void</span> (*)(<span class="keyword">int</span>))events[n].data.ptr)(events[n].events);</span><br><span class="line">        healthd_mode_ops-&gt;heartbeat();</span><br></pre></td></tr></table></figure>

<h4 id="正常开机"><a href="#正常开机" class="headerlink" title="正常开机"></a>正常开机</h4><p>正常开机时电池信息更新：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/bat_update_func.jpg" alt="update_battery"></p>
<p>正常开机部分源码分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\system\core\healthd\BatteryPropertiesRegistrar.cpp</span></span><br><span class="line">BatteryPropertiesRegistrar::publish()<span class="comment">//将&quot;batteryproperties&quot;这个Service加入ServiceManager</span></span><br><span class="line">BatteryPropertiesRegistrar::notifyListeners() <span class="comment">// 遍历 listener ，通知上层监听者，如 BatteryService</span></span><br><span class="line">BatteryPropertiesRegistrar::registerListener() <span class="comment">// 上层通过Binder注册回调</span></span><br><span class="line">     healthd_battery_update();<span class="comment">// healthd.cpp</span></span><br><span class="line">BatteryPropertiesRegistrar::getProperty() <span class="comment">//BatteryManager.java主动查询时的对应接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\system\core\healthd\healthd_mode_android.cpp</span></span><br><span class="line">healthd_mode_android_battery_update</span><br><span class="line">    gBatteryPropertiesRegistrar-&gt;notifyListeners(*props) </span><br><span class="line">    </span><br><span class="line">healthd_mode_android_init()</span><br><span class="line">    ProcessState::self()-&gt;setThreadPoolMaxThreadCount(<span class="number">0</span>);<span class="comment">// 线程池里最大线程数</span></span><br><span class="line">    IPCThreadState::self()-&gt;disableBackgroundScheduling(<span class="literal">true</span>);<span class="comment">// 禁用后台调度</span></span><br><span class="line">    IPCThreadState::self()-&gt;setupPolling(&amp;gBinderFd); <span class="comment">// 将Binder通信fd加入epoll</span></span><br><span class="line">    <span class="keyword">if</span> (healthd_register_event(gBinderFd, binder_event)) <span class="comment">//binder_event注册到gBinderFd</span></span><br><span class="line">    <span class="comment">/* 将&quot;batteryproperties&quot;加入ServiceManager */</span></span><br><span class="line">    gBatteryPropertiesRegistrar-&gt;publish(gBatteryPropertiesRegistrar);</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\system\core\healthd\BatteryMonitor.cpp </span></span><br><span class="line">BatteryMonitor::update(<span class="keyword">void</span>)</span><br><span class="line">    initBatteryProperties() <span class="comment">// 电池参数初始化</span></span><br><span class="line">    <span class="comment">/*获取文件节点数据封装于 BatteryProperties */</span></span><br><span class="line">    path.appendFormat(<span class="string">&quot;%s/%s/online&quot;</span>, POWER_SUPPLY_SYSFS_PATH, mChargerNames[i].<span class="built_in">string</span>());</span><br><span class="line">    ireadFromFile(path, buf, SIZE)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * alps\system\core\healthd\healthd_board_default.cpp</span></span><br><span class="line"><span class="comment">     * 将电池实时信息记录到 kernel log 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    healthd_board_battery_update(&amp;props);</span><br><span class="line">    healthd_mode_ops-&gt;battery_update(&amp;props) <span class="comment">// healthd_mode_android.cpp中update</span></span><br><span class="line">    </span><br><span class="line">BatteryMonitor::getXX  <span class="comment">// 获取电池状态和Health状况等</span></span><br><span class="line">BatteryMonitor::dumpState()</span><br><span class="line">BatteryMonitor::init() <span class="comment">//获取文件节点值，初始化（譬如加上节点路径： /sys/class/power_supply）写入mHealthdConfig</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="关机充电"><a href="#关机充电" class="headerlink" title="关机充电"></a>关机充电</h4><p>关机充电部分主要就是更新电量、充电状态，更新UI。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\system\core\healthd\healthd_mode_charger.cpp</span></span><br><span class="line">dump_last_kmsg() // dump前记录最后一份<span class="built_in">log</span></span><br><span class="line">/*绘制关机充电图标*/</span><br><span class="line">draw_xx()</span><br><span class="line">redraw_screen()</span><br><span class="line">healthd_mode_charger_heartbeat() // 获取最新电池状态，更新</span><br><span class="line">    handle_input_state(charger, now);</span><br><span class="line">    handle_power_supply_state(charger, now);</span><br><span class="line">    update_screen_state()  // 更新屏幕显示</span><br><span class="line">healthd_mode_charger_init()</span><br><span class="line">healthd_mode_charger_battery_update()</span><br></pre></td></tr></table></figure>

<h2 id="Framework层"><a href="#Framework层" class="headerlink" title="Framework层"></a>Framework层</h2><h3 id="Native层"><a href="#Native层" class="headerlink" title="Native层"></a>Native层</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\frameworks\native\services\sensorservice\BatteryService.cpp</span></span><br><span class="line"><span class="comment">// 定义BatteryService.h中创建的BatteryService类的成员函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\BatteryProperties.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 容器Parcel读写电池相关信息</span></span><br><span class="line"><span class="comment"> * 必须与frameworks/base/core/java/android/os/BatteryProperties.java 同步</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BatteryProperties::readFromParcel()</span><br><span class="line">BatteryProperties::writeToParcel()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\BatteryProperty.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Parcel read/write code must be kept in sync with</span></span><br><span class="line"><span class="comment"> * frameworks/base/core/java/android/os/BatteryProperty.java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BatteryProperty::readFromParcel()</span><br><span class="line">BatteryProperty::writeToParcel()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\IBatteryPropertiesListener.cpp</span></span><br><span class="line"><span class="comment">// BatteryService.java中BatteryListener的父类</span></span><br><span class="line">batteryPropertiesChanged()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\IBatteryPropertiesRegistrar.cpp</span></span><br><span class="line"><span class="comment">// BatteryManager.java和BatteryService.java通过其获取 batteryproperties ，与healthd中同步</span></span><br></pre></td></tr></table></figure>
<h3 id="Framework部分"><a href="#Framework部分" class="headerlink" title="Framework部分"></a>Framework部分</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># alps\frameworks\base\services\core\java\com\android\server\BatteryService.java</span><br><span class="line">onStart() &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 通过ServiceManager获取batteryproperties Service，</span></span><br><span class="line"><span class="comment">     * 然后将BatteryListener注册到batteryproperties中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IBinder b = ServiceManager.getService(<span class="string">&quot;batteryproperties&quot;</span>); </span><br><span class="line">    batteryPropertiesRegistrar.registerListener(<span class="keyword">new</span> BatteryListener());</span><br><span class="line">    publishBinderService(<span class="string">&quot;battery&quot;</span>, mBinderService);</span><br><span class="line">    publishLocalService(BatteryManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">processValuesLocked     </span><br><span class="line">    shutdownIfNoPowerLocked() <span class="comment">// 低电 Unplugged 关机广播</span></span><br><span class="line">    shutdownIfOverTempLocked() <span class="comment">// 温度超出，关机广播</span></span><br><span class="line">    sendIntentLocked() <span class="comment">// 电池信息改变，信息广播</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatteryListener</span></span></span><br><span class="line"><span class="class">    <span class="title">batteryPropertiesChanged</span> // 监听到电池信息改变，更新信息</span></span><br><span class="line"><span class="class">        <span class="title">atteryService</span>.<span class="title">this</span>.<span class="title">update</span>(<span class="title">props</span>)</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Led</span> // 开机充电 <span class="title">LED</span> 控制类</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># <span class="title">alps</span>\<span class="title">frameworks</span>\<span class="title">base</span>\<span class="title">core</span>\<span class="title">java</span>\<span class="title">android</span>\<span class="title">os</span>\<span class="title">BatteryManager</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class"><span class="title">queryProperty</span>() // 主动到 <span class="title">healthd</span> 查询电池信息</span></span><br><span class="line"><span class="class">    <span class="title">IBinder</span> <span class="title">b</span> </span>= ServiceManager.getService(<span class="string">&quot;batteryproperties&quot;</span>);<span class="comment">//获取batteryproperties Service  </span></span><br><span class="line">    mBatteryPropertiesRegistrar = IBatteryPropertiesRegistrar.Stub.asInterface(b);<span class="comment">//接口转化</span></span><br><span class="line">    mBatteryPropertiesRegistrar.getProperty(id, prop) <span class="comment">// 调用到Healthd BatteryPropertiesRegistrar.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************</span></span><br><span class="line"><span class="comment"> * 还有很多其他文件为上面两个文件提供服务，没有去详细分析了</span></span><br><span class="line"><span class="comment"> * 如下简单介绍一下。</span></span><br><span class="line"><span class="comment"> *****************************************************************/</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\am\BatteryStatsService.java</span><br><span class="line"><span class="comment">// 电池信息广播Intent（ACTION_BATTERY_CHANGED）用到的字符串和常量</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryManagerInternal.java</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperties.aidl</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperties.java</span><br><span class="line"><span class="comment">// 电池信息读写代码，与BatteryProperties.cpp同步</span></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperty.aidl</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperty.java</span><br><span class="line"><span class="comment">// 电池信息读写代码，与BatteryProperties.cpp同步</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryStats.java</span><br><span class="line"> <span class="comment">// 存取电池使用情况统计，包括wakelocks, processes, packages, and services等</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsImpl.aidl</span><br><span class="line"><span class="comment">// .aidl为接口定义文件， 定义电池状态信息及相关操作方法。</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsImpl.java</span><br><span class="line"><span class="comment">// 影响电池的所有信息及操作，时间以ms为单位</span></span><br></pre></td></tr></table></figure>

<h3 id="APP部分"><a href="#APP部分" class="headerlink" title="APP部分"></a>APP部分</h3><p>系统UI处理电流的部分路径主要如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatterySipper.java</span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsHelper.java</span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\BatteryMeterDrawable.java</span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\BatteryMeterView.java</span><br><span class="line"><span class="comment">// 创建系统广播接收器，接收电池信息广播，绘制电池状态图标</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\statusbar\policy\BatteryController.java</span><br><span class="line"><span class="comment">// 定义一个广播接收器并在构造器里注册接收电池信息广播，收到自己广播后回调修改pluged、level</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\power\PowerUI.java</span><br><span class="line"><span class="comment">// 创建系统广播接收器，接收电池信息广播，弹出低电警告等</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\qs\tiles\BatteryTile.java</span><br><span class="line"><span class="comment">// 定义电量百分比显示TextView类</span></span><br></pre></td></tr></table></figure>



<h1 id="关机充电流程"><a href="#关机充电流程" class="headerlink" title="关机充电流程"></a>关机充电流程</h1><p>关机充电也是在kernel里面充电，充电控制流程与开机是一致的，前面也分析到了。这里补充一个MTK软件流程图。如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging2.jpg" alt="charging flow"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>先留一个坑，等有时间了，再来绘制一个清晰易懂的流程框图。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># 源码分析</a>
              <a href="/tags/MTK/" rel="tag"># MTK</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/11/23/Android/Android-Linux-input-system-analysis/" rel="prev" title="Android(Linux) 输入子系统解析">
      <i class="fa fa-chevron-left"></i> Android(Linux) 输入子系统解析
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/11/14/Android/Android-SELinux-Permison-and-Question/" rel="next" title="Android Selinux 权限及问题">
      Android Selinux 权限及问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E7%AE%80%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">充电简析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">1.1.</span> <span class="nav-text">充电状态机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E7%AE%80%E8%A6%81%E6%B5%81%E7%A8%8B%E6%A1%86%E5%9B%BE"><span class="nav-number">1.2.</span> <span class="nav-text">充电简要流程框图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BMS-%E6%9E%B6%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">BMS 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E5%B1%82"><span class="nav-number">2.1.</span> <span class="nav-text">硬件层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-PMIC"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1.1 PMIC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fuel-Gauge"><span class="nav-number">2.1.2.</span> <span class="nav-text">Fuel Gauge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADC"><span class="nav-number">2.1.3.</span> <span class="nav-text">ADC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BootLoader%E5%B1%82"><span class="nav-number">2.2.</span> <span class="nav-text">BootLoader层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-Preloader%E5%B1%82"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.2.1 Preloader层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LK%E5%B1%82"><span class="nav-number">2.2.2.</span> <span class="nav-text">LK层</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F%E3%80%81%E5%85%85%E7%94%B5%E7%8A%B6%E6%80%81%E7%9B%91%E6%B5%8B"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">启动方式、充电状态监测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%85%E7%94%B5IC"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">初始化充电IC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-3-%E5%85%85%E7%94%B5%E5%99%A8%E7%8A%B6%E6%80%81%E7%9B%91%E6%B5%8B%E5%A4%84%E7%90%86"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">1.2.2.3 充电器状态监测处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E5%9B%BE%E6%A0%87"><span class="nav-number">2.2.2.4.</span> <span class="nav-text">充电图标</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel%E5%B1%82"><span class="nav-number">2.3.</span> <span class="nav-text">Kernel层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-ADC%E9%83%A8%E5%88%86"><span class="nav-number">2.3.1.</span> <span class="nav-text">1.3.1 ADC部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HAL%E9%83%A8%E5%88%86"><span class="nav-number">2.3.2.</span> <span class="nav-text">HAL部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Common%E9%83%A8%E5%88%86"><span class="nav-number">2.3.3.</span> <span class="nav-text">Common部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E5%88%B6%E5%8C%96%E9%83%A8%E5%88%86"><span class="nav-number">2.3.4.</span> <span class="nav-text">客制化部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%8A%82%E7%82%B9"><span class="nav-number">2.3.5.</span> <span class="nav-text">文件节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Healthd%E6%A8%A1%E5%9D%97"><span class="nav-number">2.3.6.</span> <span class="nav-text">Healthd模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Main%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.6.1.</span> <span class="nav-text">Main函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E5%BC%80%E6%9C%BA"><span class="nav-number">2.3.6.2.</span> <span class="nav-text">正常开机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E6%9C%BA%E5%85%85%E7%94%B5"><span class="nav-number">2.3.6.3.</span> <span class="nav-text">关机充电</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Framework%E5%B1%82"><span class="nav-number">2.4.</span> <span class="nav-text">Framework层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native%E5%B1%82"><span class="nav-number">2.4.1.</span> <span class="nav-text">Native层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Framework%E9%83%A8%E5%88%86"><span class="nav-number">2.4.2.</span> <span class="nav-text">Framework部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#APP%E9%83%A8%E5%88%86"><span class="nav-number">2.4.3.</span> <span class="nav-text">APP部分</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E6%9C%BA%E5%85%85%E7%94%B5%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">关机充电流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Andy.Lee"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Andy.Lee</p>
  <div class="site-description" itemprop="description">Just need to enjoy life.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">107</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huaqianlee" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:huaqianlee@gmail.com" title="E-Mail → mailto:huaqianlee@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/huaqianlee" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/huaqianlee" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/huaqianlee" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/huaqianlee" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;huaqianlee" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://huaqianlee.github.io/" title="http:&#x2F;&#x2F;huaqianlee.github.io&#x2F;">Andy.Lee's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://huaqianlee.me/" title="http:&#x2F;&#x2F;huaqianlee.me&#x2F;" rel="noopener" target="_blank">Andy.Lee's Cabin</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andy.Lee</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
